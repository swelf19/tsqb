package gen

import (
	"bytes"
	"fmt"
	"go/format"
	"strings"
	"text/template"
)

type FileMeta struct {
	Filename    string
	Filepath    string
	Imports     []string
	PackageName string
	Content     string
}

func NewFileMeta(s []StructMeta, packageName string, filename string, extraImports map[string]string) FileMeta {
	f := FileMeta{
		Imports: []string{
			"bytes",
			"fmt",
			"strings",
			"text/template",
			"github.com/swelf19/tsqb/qtypes",
			"github.com/swelf19/tsqb/qfuncs",
			"errors",
			"context",
		},
		PackageName: packageName,
		Content:     GenCode(s),
		Filename:    filename,
	}
	if extraImports != nil {
		for k := range extraImports {
			f.Imports = append(f.Imports, extraImports[k])
		}
	}
	return f
}

func GenCode(structs []StructMeta) string {
	Decls := []string{}
	for _, s := range structs {
		Decls = append(Decls,
			s.genFieldConstantsBlock(),
			s.genTableBlock(),
			s.genConditions(),
			s.genOrdering(),
			s.genBuilderStruct(),
			s.genBuilderResetMethod(),
			s.genCreateBuilderFunction(),
			s.genBuilderCommonMethods(),
			s.genBuilderBaseQueryMethods(),
			s.genComprationHelpers(),
			s.genAdditionalStructMethods(),
			s.genBuilderFetch(),
		)
	}
	return strings.Join(Decls, "\n")
}

func (f FileMeta) GenFileContent() string {
	templ := `// Code generated by tsqb from {{.BaseFileName}}. DO NOT EDIT.
	package {{.PackageName}}
	import (
		{{range .Imports}}
		"{{.}}"
		{{end}}
	)
	{{.Content}}
	`
	subQueryTemplate, err := template.New("subquery").Parse(templ)
	if err != nil {
		fmt.Println(err)
	}
	queryBuf := new(bytes.Buffer)
	err = subQueryTemplate.Execute(queryBuf, map[string]interface{}{
		"BaseFileName": f.Filename,
		"PackageName":  f.PackageName,
		"Imports":      f.Imports,
		"Content":      f.Content,
	})
	if err != nil {
		fmt.Println(err)
	}
	formattedContent, err := format.Source(queryBuf.Bytes())
	if err != nil {
		fmt.Println(err)
	}
	return string(formattedContent)
	// return string(queryBuf.String())
}
